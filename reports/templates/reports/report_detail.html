{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ data.report_meta.title }} ({{ data.report_meta.period }})</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    {% load static %}
    <link rel="stylesheet" href="{% static 'reports/css/report_detail.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        {% if data.report_meta %}
        <div class="header">
            <h1>{{ data.report_meta.title }}</h1>
            <p>{{ data.report_meta.period }}</p>
        </div>
        {% endif %}

        {% if data.weekly_headline %}
        <div class="headline">{{ data.weekly_headline }}</div>
        {% endif %}

        <!-- Executive Summary -->
        {% if data.executive_summary %}
        <div class="report-section">
            <h2>{{ data.executive_summary.title }}</h2>
            {% for item in data.executive_summary.summary_points %}
            <div class="card">
                <p>{{ item.point }}</p>
                {% if item.data_source %}<p class="data-source">Source: {{ item.data_source }}</p>{% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Performance Dashboard -->
        {% if data.performance_dashboard %}
        <div class="report-section">
            <h2>{{ data.performance_dashboard.title }}</h2>
            
            {% comment %} Naver Search Trend Chart {% endcomment %}
            <div class="chart-container">
                <canvas id="naverSearchTrendChart" class="chart-canvas"></canvas>
                {% if report.generated_chart_paths.naver_search_trend.image_path %}
                <img src="{{ report.generated_chart_paths.naver_search_trend.image_path }}" class="chart-image" alt="Naver Search Trend Chart">
                {% endif %}
            </div>
            <div class="chart-grid">
                {% comment %} YouTube Subscriber Chart {% endcomment %}
                <div class="chart-container">
                    <canvas id="youtubeSubscriberChart" class="chart-canvas"></canvas>
                    {% if report.generated_chart_paths.youtube_subscriber.image_path %}
                    <img src="{{ report.generated_chart_paths.youtube_subscriber.image_path }}" class="chart-image" alt="YouTube Subscriber Chart">
                    {% endif %}
                </div>

                {% comment %} YouTube View Chart {% endcomment %}
                <div class="chart-container">
                    <canvas id="youtubeViewChart" class="chart-canvas"></canvas>
                    {% if report.generated_chart_paths.youtube_view.image_path %}
                    <img src="{{ report.generated_chart_paths.youtube_view.image_path }}" class="chart-image" alt="YouTube View Chart">
                    {% endif %}
                </div>
            </div>
            {% comment %} Shopping SOV Chart {% endcomment %}
            {% if report.generated_chart_paths.shopping_sov %}
            <div class="chart-container">
                <canvas id="shoppingSovChart" class="chart-canvas"></canvas>
                {% if report.generated_chart_paths.shopping_sov.image_path %}
                <img src="{{ report.generated_chart_paths.shopping_sov.image_path }}" class="chart-image" alt="Shopping SOV Chart">
                {% endif %}
            </div>
            {% endif %}

            <div class="grid-container">
                {% for metric in data.performance_dashboard.metrics %}
                <div class="card">
                    <p class="card-title">{{ metric.metric_name }}</p>
                    <p style="font-size: 1.8em; font-weight: 700; color: #3b82f6;">{{ metric.value }}</p>
                    <p style="margin-top: 10px;">{{ metric.insight }}</p>
                    {% if metric.data_source %}<p class="data-source">Source: {{ metric.data_source }}</p>{% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Deep Dive -->
        {% if data.deep_dive %}
        <div class="report-section">
            <h2>{{ data.deep_dive.title }}</h2>
            {% for section in data.deep_dive.sections %}
            <div class="card">
                <h3 class="card-title">{{ section.section_title }}</h3>
                <p><strong>Finding:</strong> {{ section.finding }}</p>
                {% if section.evidence %}
                <div class="evidence-box">
                    <p><strong>Evidence:</strong> {{ section.evidence }}</p>
                </div>
                {% endif %}
                <p style="margin-top: 15px;"><strong>Recommendation:</strong> {{ section.recommendation }}</p>
                {% if section.data_source %}<p class="data-source">Source: {{ section.data_source }}</p>{% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Strategic Recommendations -->
        {% if data.strategic_recommendations %}
        <div class="report-section">
            <h2>{{ data.strategic_recommendations.title }}</h2>
            {% for rec in data.strategic_recommendations.recommendations %}
            <div class="card">
                <h3 class="card-title">
                    <span class="priority-badge priority-{{ forloop.counter }}">{{ rec.priority }}</span>
                    {{ rec.action }}
                </h3>
                <p><strong>Rationale:</strong> {{ rec.rationale }}</p>
                <p><strong>Expected Impact:</strong> {{ rec.expected_impact }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    {% if report.generated_chart_paths.naver_search_trend.chartjs_data %}
    {{ report.generated_chart_paths.naver_search_trend.chartjs_data|json_script:"naver-chart-data" }}
    {% endif %}
    {% if report.generated_chart_paths.youtube_subscriber.chartjs_data %}
    {{ report.generated_chart_paths.youtube_subscriber.chartjs_data|json_script:"youtube-subscriber-chart-data" }}
    {% endif %}
    {% if report.generated_chart_paths.youtube_view.chartjs_data %}
    {{ report.generated_chart_paths.youtube_view.chartjs_data|json_script:"youtube-view-chart-data" }}
    {% endif %}
    {% if report.generated_chart_paths.shopping_sov.chartjs_data %}
    {{ report.generated_chart_paths.shopping_sov.chartjs_data|json_script:"shopping-chart-data" }}
    {% endif %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function getChartData(scriptId) {
                const scriptElement = document.getElementById(scriptId);
                if (scriptElement && scriptElement.textContent) {
                    try {
                        return JSON.parse(scriptElement.textContent);
                    } catch (e) {
                        console.error(`Error parsing chart data from ${scriptId}:`, e);
                        return null;
                    }
                }
                return null;
            }
            // 차트를 생성하는 헬퍼 함수 (옵션 추가)
            function createResponsiveChart(canvasId, chartData) {
                const canvasElement = document.getElementById(canvasId);
                if (canvasElement && chartData) {
                    const ctx = canvasElement.getContext('2d');
                    
                    // 옵션 객체가 없으면 새로 생성
                    if (!chartData.options) {
                        chartData.options = {};
                    }
                    
                    // ★★★ 이 두 옵션이 핵심입니다 ★★★
                    // responsive: true => 컨테이너 크기에 반응하도록 설정 (기본값)
                    // maintainAspectRatio: false => 컨테이너의 높이를 그대로 따르도록 설정
                    chartData.options.responsive = true;
                    chartData.options.maintainAspectRatio = false;

                    new Chart(ctx, chartData);
                }
            }

            const naverChartData = getChartData('naver-chart-data');
            const youtubeSubscriberChartData = getChartData('youtube-subscriber-chart-data');
            const youtubeViewChartData = getChartData('youtube-view-chart-data');
            const shoppingChartData = getChartData('shopping-chart-data');

            if (naverChartData) {
                const ctx = document.getElementById('naverSearchTrendChart').getContext('2d');
                new Chart(ctx, naverChartData);
            }

            if (youtubeSubscriberChartData) {
                const ctx = document.getElementById('youtubeSubscriberChart').getContext('2d');
                new Chart(ctx, youtubeSubscriberChartData);
            }

            if (youtubeViewChartData) {
                const ctx = document.getElementById('youtubeViewChart').getContext('2d');
                new Chart(ctx, youtubeViewChartData);
            }

            if (shoppingChartData) {
                const ctx = document.getElementById('shoppingSovChart').getContext('2d');
                new Chart(ctx, shoppingChartData);
            }
        });
    </script>
    <footer style="text-align: center; margin-top: 50px; padding: 20px; color: #6b7280; font-size: 0.9em;">
        2025 Copyrights &copy;SPUTLAB All Rights Reserved.
    </footer>
</body>
</html>